<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Stock Guardia Civil - Supabase Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module">
        

NEXT_PUBLIC_SUPABASE_URL=https://ulyziwpcwaetmxmzjrxq.supabase.co
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY=sb_publishable_7aAhfIZz38PvEHH4n7iRrg_Fj9Uz85q

        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Estado Global
        window.inventory = [];
        window.history = [];
        window.appSettings = { logo: '' };
        window.currentView = 'inventory';

        // --- INICIALIZACIÓN Y SINCRONIZACIÓN ---
        const initData = async () => {
            await fetchAllData();
            
            // Suscripción en tiempo real a cambios
            supabase
                .channel('schema-db-changes')
                .on('postgres_changes', { event: '*', schema: 'public' }, () => {
                    fetchAllData();
                })
                .subscribe();
        };

        const fetchAllData = async () => {
            // Cargar Inventario
            const { data: inv } = await supabase.from('inventory').select('*').order('title');
            if (inv) window.inventory = inv;

            // Cargar Historial
            const { data: hist } = await supabase.from('history').select('*').order('created_at', { ascending: false }).limit(20);
            if (hist) window.history = hist;

            // Cargar Ajustes
            const { data: sett } = await supabase.from('settings').select('*').single();
            if (sett) window.appSettings = sett;

            render();
        };

        // --- ACCIONES DE BASE DE DATOS ---
        window.saveItem = async (title, stock) => {
            const { error } = await supabase
                .from('inventory')
                .insert([{ title: title.toUpperCase(), stock }]);
            if (error) console.error(error);
            window.showToast("Elemento añadido");
        };

        window.updateItemStock = async (id, newStock, reason) => {
            // 1. Actualizar stock
            await supabase.from('inventory').update({ stock: newStock }).eq('id', id);
            
            // 2. Registrar movimiento
            await supabase.from('history').insert([{ 
                item_id: id, 
                change_log: reason, 
                new_stock: newStock 
            }]);
            
            window.showToast("Stock actualizado");
        };

        window.saveLogo = async (base64) => {
            const { error } = await supabase
                .from('settings')
                .upsert({ id: 1, logo: base64 });
            if (error) console.error(error);
        };

        // --- NAVEGACIÓN Y RENDER ---
        window.changeView = (view) => {
            window.currentView = view;
            render();
        };

        window.render = () => {
            const root = document.getElementById('app-root');
            const nav = `
                <nav class="bg-[#004d26] text-white p-4 flex justify-between items-center shadow-md">
                    <div class="flex items-center gap-3">
                        ${window.appSettings.logo ? `<img src="${window.appSettings.logo}" class="h-8 w-8 rounded-full bg-white object-contain">` : ''}
                        <h1 class="font-black tracking-tighter">GC STOCK <span class="font-light opacity-50">SUPABASE</span></h1>
                    </div>
                    <div class="flex gap-4 text-[10px] font-bold uppercase tracking-widest">
                        <button onclick="changeView('inventory')" class="${window.currentView === 'inventory' ? 'text-yellow-400' : ''}">Almacén</button>
                        <button onclick="changeView('history')" class="${window.currentView === 'history' ? 'text-yellow-400' : ''}">Historial</button>
                        <button onclick="changeView('admin')" class="${window.currentView === 'admin' ? 'text-yellow-400' : ''}">Ajustes</button>
                    </div>
                </nav>
            `;

            let content = '';
            if (window.currentView === 'inventory') content = renderInventory();
            else if (window.currentView === 'history') content = renderHistory();
            else content = renderAdmin();

            root.innerHTML = `${nav}<main class="p-6 max-w-4xl mx-auto">${content}</main>`;
        };

        const renderInventory = () => `
            <div class="flex justify-between items-end mb-8">
                <h2 class="text-3xl font-black text-slate-800 italic uppercase">Inventario Actual</h2>
                <button onclick="addItem()" class="bg-slate-900 text-white text-[10px] px-4 py-2 rounded font-bold uppercase tracking-widest">Añadir Artículo</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${window.inventory.map(item => `
                    <div class="bg-white border-2 border-slate-100 p-5 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-slate-500 text-[10px] uppercase tracking-widest mb-1">Material</h3>
                        <div class="text-xl font-black text-slate-900 uppercase mb-4">${item.title}</div>
                        <div class="flex justify-between items-center">
                            <div class="text-4xl font-black text-[#004d26]">${item.stock} <span class="text-xs font-medium text-slate-400">Uds</span></div>
                            <div class="flex gap-2">
                                <button onclick="adjust('${item.id}', ${item.stock}, -1)" class="w-10 h-10 bg-slate-100 rounded-full font-bold">-</button>
                                <button onclick="adjust('${item.id}', ${item.stock}, 1)" class="w-10 h-10 bg-slate-100 rounded-full font-bold">+</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        const renderHistory = () => `
            <h2 class="text-2xl font-black mb-6 uppercase italic">Últimos Movimientos</h2>
            <div class="space-y-2">
                ${window.history.map(h => {
                    const item = window.inventory.find(i => i.id === h.item_id);
                    return `
                        <div class="bg-white p-3 border-l-4 border-[#004d26] shadow-sm flex justify-between items-center">
                            <div>
                                <div class="font-bold text-sm uppercase">${item?.title || 'Eliminado'}</div>
                                <div class="text-[10px] text-slate-400 uppercase">${h.change_log}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-xs">${new Date(h.created_at).toLocaleDateString()}</div>
                                <div class="text-[10px] font-mono opacity-50 text-green-700">Stock final: ${h.new_stock}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;

        const renderAdmin = () => `
            <div class="bg-white p-8 border-2 border-slate-100 rounded-3xl">
                <h2 class="text-xl font-bold mb-4 uppercase">Ajustes de la Aplicación</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Logo de la Unidad</label>
                        <input type="file" onchange="uploadLogo(event)" class="text-xs">
                    </div>
                </div>
            </div>
        `;

        // --- FUNCIONES AUXILIARES ---
        window.addItem = () => {
            const t = prompt("Nombre del material:");
            const s = prompt("Stock inicial:", "0");
            if(t) window.saveItem(t, parseInt(s) || 0);
        };

        window.adjust = (id, current, delta) => {
            const reason = delta > 0 ? "Entrada de material" : "Salida/Retirada";
            window.updateItemStock(id, current + delta, reason);
        };

        window.uploadLogo = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => window.saveLogo(ev.target.result);
            if(file) reader.readAsDataURL(file);
        };

        window.showToast = (m) => {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        };

        window.onload = initData;

    </script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <div id="app-root">
        <div class="flex h-screen items-center justify-center font-bold text-slate-300 animate-pulse uppercase tracking-[0.5em] text-xs">
            Conectando con Supabase...
        </div>
    </div>
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-3 rounded-full text-[10px] font-bold uppercase tracking-widest opacity-0 transition-opacity pointer-events-none shadow-2xl"></div>
</body>
</html>
